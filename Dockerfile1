FROM centos:7

RUN sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-* && \
    sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*

RUN yum install  -y wget gcc make pcre-devel openssl-devel  \
   apr-devel apr-util-devel 
  

RUN wget https://dlcdn.apache.org/httpd/httpd-2.4.63.tar.gz && \
         mkdir /opt/httpd && \
        tar -zxf httpd-2.4.63.tar.gz -C /opt/httpd   --strip-components=1 && \
        cd /opt/httpd && \
       ./configure    && \
       make && make install
# Install EPEL Repo
RUN yum install -y epel-release  yum-utils && \
   yum  -y install http://rpms.remirepo.net/enterprise/remi-release-7.rpm


 
# Install PHP
RUN yum --enablerepo=remi-php73  -y install php php-bcmath php-cli php-common php-gd php-intl php-ldap php-mbstring \
    php-mysqlnd mod_php php-pear php-soap php-devel  php-xml php-xmlrpc php-zip
   

#install redis
RUN yum -y install redis

#install kafka
RUN yum -y install librdkafka librdkafka-devel && \
  pecl install rdkafka && \
   echo "extension=rdkafka.so" > /etc/php.d/rdkafka.ini


RUN echo "<?php phpinfo(); ?>" >  /usr/local/apache2/htdocs/info.php 

# Configure Apache to use PHP and listen on port 8082
RUN echo "Listen 8082" > /usr/local/apache2/conf/httpd.conf && \
    echo "ServerName localhost" >> /usr/local/apache2/conf/httpd.conf && \
    echo "LoadModule php7_module modules/libphp7.so" >> /usr/local/apache2/conf/httpd.conf && \
    echo "AddHandler php7-script .php" >> /usr/local/apache2/conf/httpd.conf && \
    echo "DirectoryIndex index.php index.html" >> /usr/local/apache2/conf/httpd.conf && \
    echo "DocumentRoot \"/usr/local/apache2/htdocs\"" >> /usr/local/apache2/conf/httpd.conf && \
    echo "<Directory \"/usr/local/apache2/htdocs\">" >> /usr/local/apache2/conf/httpd.conf && \
    echo "    AllowOverride All" >> /usr/local/apache2/conf/httpd.conf && \
    echo "    Require all granted" >> /usr/local/apache2/conf/httpd.conf && \
    echo "</Directory>" >> /usr/local/apache2/conf/httpd.conf && \
    echo "Include conf/extra/httpd-default.conf" >> /usr/local/apache2/conf/httpd.conf


EXPOSE 80

CMD ["/usr/local/apache2/bin/httpd", "-D" , "FOREGROUND"]
